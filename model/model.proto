syntax = "proto3";

package model;
import "google/protobuf/timestamp.proto";
import "github.com/mwitkow/go-proto-validators/validator.proto";
import "google/api/annotations.proto";
// Common


message CompletionResult {
    bool successful = 1 [(validator.field) = {msg_exists : true}];
    Datum datum = 2 [(validator.field) = {msg_exists : true}];
}

message BlobDatum {
    string blob_id = 1 [(validator.field) = {msg_exists : true}];
    string content_type = 2 [(validator.field) = {msg_exists : true}];
    uint64 length = 3 [(validator.field) = {msg_exists : true}];
}

message HTTPHeader {
    string key = 1 [(validator.field) = {msg_exists : true}];
    string value = 2 [(validator.field) = {msg_exists : true}];
}
enum HTTPMethod {
    unknown_method = 0;
    get = 1;
    head = 2;
    post = 3;
    put = 4;
    delete = 5;
    options = 7;
    patch = 6;
}

message HTTPReqDatum {
    BlobDatum body = 1;
    repeated HTTPHeader headers = 3;
    HTTPMethod method = 4 [(validator.field) = {msg_exists : true}];
}

message HTTPRespDatum {
    BlobDatum body = 1;
    repeated HTTPHeader headers = 3;
    uint32 status_code = 4 [(validator.field) = {msg_exists : true}];
}

enum ErrorDatumType {
    unknown_error = 0;
    stage_timeout = 1;
    stage_failed = 2;
    function_timeout = 3;
    function_invoke_failed = 4;
    stage_lost = 5;
    invalid_stage_response = 6;
}


message EmptyDatum {

}

message StageRefDatum {
    string stage_ref = 1 [(validator.field) = {msg_exists : true}];
}

message ErrorDatum {
    ErrorDatumType type = 1 [(validator.field) = {msg_exists : true}];
    string message = 2;
}

enum StateDatumType {
    unknown_state = 0;
    succeeded = 1;
    failed = 2;
    cancelled = 3;
    killed = 4;
}

message StateDatum {
    StateDatumType type = 1 [(validator.field) = {msg_exists : true}];
}

message Datum {
    oneof val {
        EmptyDatum empty = 1;
        BlobDatum blob = 2;
        ErrorDatum error = 3;
        StageRefDatum stage_ref = 4;
        HTTPReqDatum http_req = 5;
        HTTPRespDatum http_resp = 6;
        StateDatum state = 7;
    }
}

enum CompletionOperation {
    unknown_operation = 0;
    acceptEither = 1;
    applyToEither = 2;
    thenAcceptBoth = 3;
    thenApply = 4;
    thenRun = 5;
    thenAccept = 6;
    thenCompose = 7;
    thenCombine = 8;
    whenComplete = 9;
    handle = 10;
    supply = 11;
    invokeFunction = 12;
    completedValue = 13;
    delay = 14;
    allOf = 15;
    anyOf = 16;
    externalCompletion = 17;
    exceptionally = 18;
    terminationHook = 19;
    exceptionallyCompose = 20;

}

// Commands
message AddStageRequest {
    string graph_id = 1 [(validator.field) = {msg_exists : true}];
    CompletionOperation operation = 2 [(validator.field) = {msg_exists : true}];
    BlobDatum closure = 3;
    repeated string deps = 4;
    string code_location = 5;
    string caller_id = 6;
}

message CompleteStageExternallyRequest {
    string graph_id = 1;
    string stage_id = 2;
    CompletionResult result = 3;
    string code_location = 4;
    string caller_id = 5;
}


message AddCompletedValueStageRequest {
    string graph_id = 1 [(validator.field) = {msg_exists : true}];
    CompletionResult result = 2 [(validator.field) = {msg_exists : true}];
    string code_location = 3;
    string caller_id = 4;
}

message AddDelayStageRequest {
    string graph_id = 1 [(validator.field) = {msg_exists : true}];
    int64 delay_ms = 2 [(validator.field) = {msg_exists : true}];
    string code_location = 3;
    string caller_id = 4;
}


message AddInvokeFunctionStageRequest {
    string graph_id = 1 [(validator.field) = {msg_exists : true}];
    string function_id = 2 [(validator.field) = {msg_exists : true}];
    HTTPReqDatum arg = 3 [(validator.field) = {msg_exists : true}];
    string code_location = 4;
    string caller_id = 5;
}


message AddStageResponse {
    string graph_id = 1;
    string stage_id = 2;
}

message CommitGraphRequest {
    string graph_id = 1 [(validator.field) = {msg_exists : true}];
}

message GraphRequestProcessedResponse {
    string graph_id = 1;
}


message CompleteDelayStageRequest {
    string graph_id = 1;
    string stage_id = 2;
    CompletionResult result = 3;
}


message CompleteStageExternallyResponse {
    string graph_id = 1;
    string stage_id = 2;
    bool successful = 3;
}

message DeactivateGraphRequest {
    string graph_id = 1;
}

message CreateGraphRequest {
    string function_id = 1 [(validator.field) = {msg_exists : true}];
    string graph_id = 2;

}

message CreateGraphResponse {
    string graph_id = 1;
}

message FaasInvocationResponse {
    string graph_id = 1;
    string stage_id = 2;
    string function_id = 3;

    CompletionResult result = 4;
    string call_id = 5;
}


message GetGraphStateRequest {
    string graph_id = 1 [(validator.field) = {msg_exists : true}];
}

message GetGraphStateResponse {
    message StageRepresentation {
        string type = 1;
        string status = 2;
        repeated string dependencies = 3;
    }
    map<string, StageRepresentation> stages = 1;
    string function_id = 2;
    string graph_id = 3;
}

message ListGraphsRequest {
    ListGraphsFilter filter = 1;
}

enum ListGraphsFilter {
    unknown = 0;
    all = 1;
    running = 2;
    completed = 3;
}


message StreamLifecycle {

}
message StreamGraph {
    string graph_id = 2;
    uint64 from_seq = 3;
}

// Request a stream of events
message StreamRequest {

    oneof query{
        StreamLifecycle lifecycle = 1;
        StreamGraph graph = 2;
    }
}

message ListGraphResponse {
    string graph_id = 1;
}

message ListGraphsResponse {
    repeated ListGraphResponse graphs = 1;
}

message AwaitStageResultRequest {
    string graph_id = 1 [(validator.field) = {msg_exists : true}];
    string stage_id = 2 [(validator.field) = {msg_exists : true}];
    uint64 timeout_ms = 3;
}

message AwaitStageResultResponse {
    string graph_id = 1;
    string stage_id = 2;
    CompletionResult result = 3;
}


message InvalidGraphOperation {
    string graph_id = 1;
    string err = 2;
}

message InvalidStageOperation {
    string graph_id = 1;
    string err = 2;
    string stage_id = 3;
}

// Invoke commands
message InvokeFunctionRequest {
    string graph_id = 1 [(validator.field) = {msg_exists : true}];
    string stage_id = 2 [(validator.field) = {msg_exists : true}];
    string function_id = 3 [(validator.field) = {msg_exists : true}];
    HTTPReqDatum arg = 4 [(validator.field) = {msg_exists : true}];
}

message InvokeStageRequest {
    string graph_id = 1 [(validator.field) = {msg_exists : true}];
    string stage_id = 2 [(validator.field) = {msg_exists : true}];
    string function_id = 3 [(validator.field) = {msg_exists : true}];
    CompletionOperation operation = 4 [(validator.field) = {msg_exists : true}];
    repeated CompletionResult args = 5;
    BlobDatum closure = 6 [(validator.field) = {msg_exists : true}];
    bool exceptional = 7 [(validator.field) = {msg_exists : true}];
}

// Events

message GraphEvent {
    uint64 seq = 1;
    oneof val {
        GraphCreatedEvent graph_created = 2;
        GraphTerminatingEvent graph_termianting = 3;
        GraphCompletedEvent graph_completed = 4;
        DelayScheduledEvent delay_scheduled = 5;
        StageAddedEvent stage_added = 6;
        StageCompletedEvent stage_completed = 7;
        StageComposedEvent stage_composed = 8;
        FaasInvocationStartedEvent faas_invocation_started = 9;
        FaasInvocationCompletedEvent faas_invocation_completed = 10;
    }

}

// Graph created
message GraphCreatedEvent {
    string graph_id = 1;
    string function_id = 2;
    google.protobuf.Timestamp ts = 3;
}

// A delay has started - this marks the relative start of an event when a delay node is recovered
message DelayScheduledEvent {
    string stage_id = 1;
    int64 time_ms = 2;
    google.protobuf.Timestamp ts = 3;
}

// Graph termination has started - no more changes can be made to this graph
// this will be fillowed by a completion event when any termination hooks have run
message GraphTerminatingEvent {
    string graph_id = 1;
    string function_id = 2;
    StateDatumType state = 3;
    google.protobuf.Timestamp ts = 4;
}

// Graph is complete  and will no longer change
message GraphCompletedEvent {
    string graph_id = 1;
    string function_id = 2;
    google.protobuf.Timestamp ts = 3;

}

// The graph is committed - this typically indicates that the function that created the flow has completed
// once this event has been posted the graph will finish when all active or pending nodes have completed.
message GraphCommittedEvent {
    string graph_id = 1;
    google.protobuf.Timestamp ts = 2;

}

// A stage was added to the graph
message StageAddedEvent {
    string stage_id = 1;
    CompletionOperation op = 2;
    BlobDatum closure = 3;
    repeated string dependencies = 4;
    google.protobuf.Timestamp ts = 5;
    string code_location = 6;
    string caller_id = 7;
}

// A stage completed  - downstream stages may be triggered
message StageCompletedEvent {
    string stage_id = 1;
    CompletionResult result = 2;
    google.protobuf.Timestamp ts = 3;
}

// A stage was composed into  stage_id  - stage_id will compelete with the saem result as composed_stage_id
message StageComposedEvent {
    string stage_id = 1;
    string composed_stage_id = 2;
    google.protobuf.Timestamp ts = 3;
}

// A call to the FaaS has started
message FaasInvocationStartedEvent {
    string stage_id = 1;
    google.protobuf.Timestamp ts = 2;
    string function_id = 3;
}

// A call to the FaaS completed
message FaasInvocationCompletedEvent {
    string stage_id = 1;
    CompletionResult result = 2;
    google.protobuf.Timestamp ts = 3;
    string call_id = 4;
}



service FlowService {
    rpc CreateGraph (CreateGraphRequest) returns (CreateGraphResponse) {
        option (google.api.http) = {
            post: "/v1/flow/create",
            body: "*"
        };
    };

    rpc AddStage (AddStageRequest) returns (AddStageResponse) {
        option (google.api.http) = {
            post: "/v1/flow/{graph_id}/stage",
            body: "*"
        };
    };

    rpc AddInvokeFunction (AddInvokeFunctionStageRequest) returns (AddStageResponse) {
        option (google.api.http) = {
            post: "/v1/flow/{graph_id}/invoke",
            body: "*"
        };
    };
    rpc AddDelay (AddDelayStageRequest) returns (AddStageResponse) {
        option (google.api.http) = {
            post: "/v1/flow/{graph_id}/delay",
            body: "*"
        };
    };

    rpc AwaitStageResult (AwaitStageResultRequest) returns (AwaitStageResultResponse) {
        option (google.api.http) = {
            get: "/v1/flow/{graph_id}/stages/{stage_id}/await"
        };
    };

    rpc CompleteStageExternally (CompleteStageExternallyRequest) returns (CompleteStageExternallyResponse) {
        option (google.api.http) = {
            post: "/v1/flow/{graph_id}/stages/{stage_id}/complete",
            body: "*",
        };
    };

    rpc Commit (CommitGraphRequest) returns (GraphRequestProcessedResponse) {
        option (google.api.http) = {
            post: "/v1/flow/{graph_id}/commit",
            body: "*"
        };
    };

    rpc GetGraphState (GetGraphStateRequest) returns (GetGraphStateResponse) {
        option (google.api.http) = {
            get: "/v1/flow/{graph_id}"
        };
    };

    rpc StreamEvents (StreamRequest) returns (stream GraphEvent) {
        option (google.api.http) = {
            get: "/v1/flow/stream"
        };
    }

    //	SubscribeGraphEvents(graphID string, fromIndex int, fn persistence.StreamCallBack) (*eventstream.Subscription, error)
    //	QueryGraphEvents(graphID string, fromIndex int, p persistence.StreamPredicate, fn persistence.StreamCallBack) error
    //	UnsubscribeStream(sub *eventstream.Subscription)

}